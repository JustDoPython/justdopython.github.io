---
layout: post
title: 我擦！发红包遇到了微信抖动！
category: python
tagline: by 闲欢
tags: 
  - python
  - 微信
  - bug
---


下午和老婆手牵手心连心去“好时光”照相馆拍照片，记录我们的美好时刻。

拍完一组照片，在等待摄影师修图的时候，老婆站在我身后给我捶背，说我开车辛苦了，给我揉揉肩捶捶背。这待遇真是羡煞了路人甲，作为男人，这种满足感也是无与伦比的。

![](http://www.justdopython.com/assets/images/2021/01/wxdd/hxpz.gif)

这时候，作为一个男人，咱也不甘示弱：掏出手机，打开微信，点击“转账”，输入520，转账留言还不忘附一句“么么哒”。

一气呵成之后，我提醒老婆赶紧看微信，老婆打开微信，刷了几下，啥都没看到，跑来问我说，看什么呀？

我提高嗓门说：给你发了个大包，你赶紧领了，过时不候哈！

哪里有大包嘛？你看看，啥也没收到呀！

听到这句话，我愣了一下，随即冒了一丝冷汗：没收到？难道我发错人了？完了完了，赶紧检查一下，要是发到另一个女孩的微信上就跳进黄河也洗不清了！

我赶忙打开手机，确认了三遍，没发错，这才松了一口气。我说你看，我已经发过去了，你没接收到，你是不是信号不好，你连 WiFi 看看！

老婆连了 WiFi，也还是没看到。我打开手机微博，刷新内容都没问题，心理一百个为什么。。。

这时候修照片的老板娘（据说像某位明星）跟我们说，照片修好了，让我们看看。我们看了之后说很满意，把我严肃的表情修成了微笑，很棒！

接着老板娘让我加她微信，把底片发给我。我微信扫一扫二维码，添加了微信。可是老板娘等了半天，也没有收到好友请求。我又添加了一次，还是一样的结果。我不信邪，切换到了另一张联通 5G 卡，又添加了一下，结果同样没收到。

我就郁闷了，这都 4G 加 5G ，一共 9G 了，怎么还是收不到请求呢？

结果让老婆添加，一次性就成功了。

当时贼郁闷，炫耀的红包老婆没有收到，明星老板娘的微信也没加上，今天这人品是咋啦？

草草收场之后，我们离开了影楼，老婆路上还念叨着红包，看着她可怜兮兮的样子，我心疼啊，于是我又拿起手机转了一个 520 过去，为了区分，我特意在转账留言后面加了一个企鹅发爱心的表情。

这次发过去她就看到了，以迅雷不及掩耳之势点了红包。令人意想不到的是，她收了红包之后，马上又冒出来一个，也就是之前没收到的那个，这时候也出现了。毫无意外，以抢红包的手速马上又点了一次，欣喜若狂地对我说：谢谢老公，两个红包都收到了！

![](http://www.justdopython.com/assets/images/2021/01/wxdd/fhb.jpeg)

这杀千刀的微信，害人啊！微信余额总共才 1000 出头，这一下子掏空了，接下来日子怎么过啊！大家可以理解我此时内心的 OS 吗？

### 思路和实现

晚上，回到家刷微博，无意间发现“微信bug”上了热搜，看到微信官方的微博，才知道自己被微信坑了：

![](http://www.justdopython.com/assets/images/2021/01/wxdd/wxgf.jpg)

微信团队表示，今天14点左右，部分微信用户遇到了消息收取延迟情况，原因是系统抖动，目前已经修复完成。

微信团队还宽慰大家：你家网络应该没啥问题。

我内心想：我家网络是没问题，我家家庭和睦关系差点遭殃！

看了这个解释，作为技术人员，我的第一反应当然是去了解一下什么是“系统抖动”，我去网上搜索相关资料，解释是这样的：

> 如果低优先级进程所分配的帧数低于计算机体系结构所需的最小数量，那么必须暂停该进程执行。然后，应调出它的所有剩余页面，以便释放所有分配的帧。这个规定引入了中级 CPU 调度的换进换出层。
> 
> 事实上，需要研究一下没有“足够”帧的进程。如果进程没有需要支持活动使用页面的帧数，那么它会很快产生缺页错误。此时，必须置换某个页面。然而，由于它的所有页面都在使用中，所以必须立即置换需要再次使用的页面。因此，它会再次快速产生缺页错误，再一次置换必须立即返回的页面，如此快速进行。
> 
> 这种高度的页面调度活动称为抖动。如果一个进程的调页时间多于它的执行时间，那么这个进程就在抖动。

系统抖动的原因是什么呢？

> 操作系统监视 CPU 利用率。如果 CPU 利用率太低，那么通过向系统引入新的进程来增加多道程度。采用全局置换算法会置换任何页面，而不管这些页面属于哪个进程。
> 
> 现在假设进程在执行中进入一个新阶段，并且需要更多的帧。它开始出现缺页错误，并从其他进程那里获取帧。然而，这些进程也需要这些页面，因此它们也会出现缺页错误，并且从其他进程中获取帧。这些缺页错误进程必须使用调页设备以将页面换进和换出。当它们为调页设备排队时，就绪队列清空。随着进程等待调页设备，CPU 利用率会降低。
> 
> CPU 调度程序看到 CPU 利用率的降低，进而会增加多道程度。新进程试图从其他运行进程中获取帧来启动，从而导致更多的缺页错误和更长的调页设备队列。因此，CPU 利用率进一步下降，并且 CPU 调度程序试图再次增加多道程度。这样就出现了抖动，系统吞吐量陡降，缺页错误率显著增加。结果，有效内存访问时间增加，没有工作可以完成，因为进程总在忙于调页。


![](http://www.justdopython.com/assets/images/2021/01/wxdd/xtdd.jpg)

在本次微信事件中，我们通俗的理解为：

> 所谓系统抖动(thrashing)，是一个计算机专业名词，指的是虚拟内存方案中的一种现象，通常是因为内存或其他资源耗尽或有限，导致无法完成所要执行的操作。
> 
> 当上述情况发生时，程序就会通过操作系统发出请求，操作系统则试图从其他程序中调用所需资源，导致新的请求不能得到满足。
> 
> 系统抖动发生时，系统时间会消耗在低速的I/O上，更多地进行页面交换而不是指令执行，进而大大降低系统效率。


用大白话说就是：微信消息收发系统的资源不够用了。


今天虽然钱包空了，感觉损失了几个亿，并且差点好事变坏事，但是经历了一次微信的重大事件，而且学到了点新知识，也算是不小的收获了！